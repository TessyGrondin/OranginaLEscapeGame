<!DOCTYPE html>
<html>
<head>
  <title>Escape Game</title>
  <meta charset="UTF-8">
  <style>
  html, body {
    height: 100%;
    margin: 0;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas {
    border: 1px solid black;
  }
  </style>
</head>
<body>
<canvas width="375" height="667" id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const context = canvas.getContext('2d');

let win = false;
let gameOver = false;
let menu = true;

let roundValue = true;

let transitionImage = new Image();
transitionImage.src = "fondu.png"
let granMerKal = new Image();
granMerKal.src = "granMerKal.png"
let victory = new Image();
victory.src = "victoire.png"
let roomImage = new Image();
roomImage.src = "haunted-house-halloween.gif";
let buttonImage = new Image();
buttonImage.src = "button.png";
let cursor = new Image();
cursor.src = "cursor.png";

let rooms = ["croisement.jpg", "salleDeBain.jpg", "cour.jpg", "haunted-house-halloween.gif"];
let room = -1;

let clues = ["1ère mission : quelle porte choisiras-tu?\nAttention, la victoire se cache dans les petits détails!", "Bravo, tu as fait le bon choix, te voici maintenant dans la salle de bain. 2 solutions pour s’évader : porte ou fenêtre? A toi de faire le bon choix!", "Tu as l’œil, bravo Enfin tu es proche de la sortie mais attention ce n’est pas fini! La porte du fond me semble bien mystérieuse, pas toi? Peut-être préfère tu passer par le portail"];
let myFont = new FontFace('okami', 'url(Okami.otf)');
myFont.load().then(function(font){
  document.fonts.add(font);
});

let allowShowCount = false;
let show = 0;
let cursorFrame = 0;
let cursorSize = 64;
let rightPosition = [{x:75, y:320}, {x:160, y:250}, {x:270, y:400}];
let wrongPosition = [{x:230, y:320}, {x:280, y:450}, {x:165, y:330}];

let transitionFrames = [0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0];
let visible = false;
let transitionFrame = -1;

context.fillStyle = 'yellow';
context.textAlign = "center";

let time = 0;

function loop() {
  requestAnimationFrame(loop);
  context.clearRect(0,0,canvas.width,canvas.height);

  if (menu) {
    context.drawImage(roomImage, 0, 0, roomImage.width, roomImage.height, 0, 0, canvas.width, canvas.height);
    context.font = "30px 'okami'";
    context.fillText("T'échapperas-tu ?" , canvas.width / 2, 70);
    context.font = "20px 'okami'";
    context.fillText("Choisis les bonnes", canvas.width / 2, 150);
    context.fillText("issues pour t'échapper !", canvas.width / 2, 170);
    context.fillText("appuie pour jouer", canvas.width / 2, canvas.height - 10);
  } else if (!win && !gameOver) {
    context.drawImage(roomImage, 0, 0, roomImage.width, roomImage.height, 0, 0, canvas.width, canvas.height);
    context.drawImage(cursor, cursorFrame * cursorSize, 0, cursorSize, cursor.height, rightPosition[room].x, rightPosition[room].y, cursorSize, cursorSize);
    context.drawImage(cursor, cursorFrame * cursorSize, 0, cursorSize, cursor.height, wrongPosition[room].x, wrongPosition[room].y, cursorSize, cursorSize);
    context.textAlign = "center";
    context.font = "30px 'okami'";
    context.fillText(clues[room] , canvas.width / 2, 150);
  } else if (win) {
    context.drawImage(victory, 0, 0, victory.width, victory.height, 0, 0, canvas.width, canvas.height);
    context.font = "40px 'okami'";
    context.fillText("Bravo, tu as réussi avec brio à t’évader en  " + time + "s!", canvas.width / 2, canvas.height / 2 + 60);
    context.font = "20px 'okami'";
    context.fillText("appuie pour rejouer", canvas.width / 2, canvas.height - 40);
  } else {
    context.drawImage(granMerKal, 0, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
    context.font = "40px 'okami'";
    context.fillText("Perdu! Tu as manqué de vigilance!", canvas.width / 2, canvas.height / 2 + 70);
    context.font = "20px 'okami'";
    context.fillText("appuie pour rejouer", canvas.width / 2, canvas.height - 10);
  }
  if (transitionFrame != -1)
    context.drawImage(transitionImage, transitionFrames[transitionFrame] * canvas.width, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
}

document.addEventListener('click', function(e) {
  let relativeX = e.x - canvas.offsetLeft;
  let relativeY = e.y - canvas.offsetTop;

  if (visible || allowShowCount)
    return;

  if (!win && !menu && !gameOver) {
    let ok = true;
    if (relativeX >= rightPosition[room].x && relativeX < rightPosition[room].x + cursorSize && relativeY >= rightPosition[room].y && relativeY < rightPosition[room].y + cursorSize)
      roundValue = true;
    else if (relativeX >= wrongPosition[room].x && relativeX < wrongPosition[room].x + cursorSize && relativeY >= wrongPosition[room].y && relativeY < wrongPosition[room].y + cursorSize)
      roundValue = false;
    else
      ok = false;
    visible = ok;
    return;
  }
  if (menu) {
    visible = true;
    return;
  }
  if (gameOver || win) {
    time = 0;
    win = false;
    room = -1;
    roomImage.src = "entree.jpg";
    context.fillStyle = 'yellow';
    gameOver = false;
    menu = true;
    roundValue = true;
  }
 });

function showButton() {
  if (show == 1) {
    visible = true;
    show = 0;
    allowShowCount = false;
  }
  if (!allowShowCount)
    return;
  show++;
}

function transition()
{
  if (visible) {
    transitionFrame++;
    if (transitionFrame == 6) {
      context.textAlign = "center";
      if (menu)
        menu = false;
      if (roundValue == false) {
        context.fillStyle = 'red';
        gameOver = true;
      } else {
        room++;
        roomImage.src = rooms[room];
      }
      if (room == rooms.length - 1)
        win = true;
    }
    if (transitionFrame == transitionFrames.length) {
      transitionFrame = -1;
      visible = false;
    }
  }
}

function increment() {
  if (!menu && !win && !gameOver)
    time++;
}

function animateCursor() {
  if (!menu && !win && !gameOver)
    cursorFrame++;
  if (cursorFrame > 5)
    cursorFrame = 0;
}

setInterval(transition, 50);
setInterval(increment, 1000);
setInterval(showButton, 500);
setInterval(animateCursor, 80);

requestAnimationFrame(loop);
</script>
</body>
</html>